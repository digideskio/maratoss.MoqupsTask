@using Moqups.App.Models
@using Moqups.Entities
@using Page = Moqups.Entities.Page
@model EditUserModel

<style type="text/css">
    select.listbox {
        width: 100%;
        height: 100%;
        margin: 0 auto;
    }

    td.ui-droppable {
        border: gray 1px solid;
        width: 100px;
        height: 100px;
    }
</style>

<script>
    $(function () {
        $('.ui-draggable').draggable({
            helper : 'clone',
            opacity : 0.3
        });
        
        $('.ui-droppable').droppable({
            tolerance : 'fit',
            accept : '.ui-draggable',
            drop : function(event, ui) {
                $(this).append(ui.draggable);
            }
        });

        $('[title]').tooltip();
    });
    
    function deleteEntity(idEntity) {
        if (confirm("Are you sure?")) {
            window.location.href = '@Url.Action("DeleteUser", "Home")/' + idEntity;
        }
    }

    function submitForm() {
        $('#userPages').find("input[type=hidden]").each(function(index, value) {
            var r = ";";
        });

        $('#availablePages').empty();
        $('#rootForm').submit();
    }

</script>

@using (Html.BeginForm("SaveOrUpdate", "Home", FormMethod.Post, new { id = "rootForm" }))
{
    @Html.HiddenFor(x => x.User.Id)
    <table width="100%">
        <tr>
            <td>Firstname</td>
            <td>@Html.TextBoxFor(x => x.User.Firstname, new { id = "firstname", title = TooltipService.GetTooltipFor<User>(x => x.Firstname, Model.User.Id > 0 ? "EDIT" : "ADD") })</td>
        </tr>
        <tr>
            <td>Lastname</td>
            <td>@Html.TextBoxFor(x => x.User.Lastname, new { title = TooltipService.GetTooltipFor<User>(x => x.Lastname, Model.User.Id > 0 ? "EDIT" : "ADD") })</td>
        </tr>
        <tr>
            <td>Status</td>
            <td>@Html.DropDownListFor(x => x.User.Status, @Model.StatusList)</td>
        </tr>
        <tr>
            <td></td>
            <td>@Html.CheckBoxFor(x => x.User.IsAdmin)Admin</td>
        </tr>
        <tr>
            <td>User's pages</td>
            <td>Available pages</td>
        </tr>
        <tr>
            <td class="ui-droppable" id="userPages">
                @*                @foreach (Page page in @Model.User.Pages)*@
                @for (int i = 0; i < @Model.User.Pages.Count; i++)
                {
                    <div class="ui-draggable">
                        @Model.User.Pages[i].Name
                        @Html.HiddenFor(x => x.User.Pages[i].Id)
                    </div>
                }
            </td>
            <td class="ui-droppable" id="availablePages">
                @for (int i = 0; i < @Model.AvailablePages.Count; i++)
                {
                    <div class="ui-draggable">
                        @Model.AvailablePages[i].Name
                        @Html.Hidden(string.Format("User.Pages[{0}].Id", @Model.User.Pages.Count + i), @Model.AvailablePages[i].Id)
                    </div>
                }
            </td>
        </tr>
    </table>
    
    <div id="buttons">
        <input type="button" value="Save" onclick="submitForm()" />
        <input type="button" value="Cancel" id="cancelButton" onclick="window.history.back()" />
        @if (Model.User.Id > 0)
        {
            <input type="button" value="Delete" onclick="deleteEntity(@Model.User.Id)" />
        }
    </div>
}
